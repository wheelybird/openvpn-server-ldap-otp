# PAM LDAP TOTP Authentication Configuration
#
# This file configures the standalone PAM module that performs both
# LDAP password authentication and TOTP validation in a single module.
#
# Format: keyword value (values are NOT quoted, whitespace-separated)
# File permissions should be 600 (contains LDAP bind password if used)

# ============================================================================
# LDAP Connection Settings (Required)
# ============================================================================

# LDAP server URI
# Will be set by environment variable or updated during container initialisation
ldap_uri ldap://localhost

# LDAP base DN for user searches
# Will be set by environment variable or updated during container initialisation
ldap_base dc=example,dc=com

# LDAP bind DN for service account (optional - leave blank for anonymous)
# If using authenticated bind, set this to a service account DN
ldap_bind_dn

# LDAP bind password (optional - only if ldap_bind_dn is set)
# WARNING: This file should have 600 permissions if password is set
ldap_bind_password

# LDAP attribute for username lookup
login_attribute uid

# Require unique LDAP match
require_unique_match false

# ============================================================================
# TLS/SSL Settings
# ============================================================================

# TLS mode: none, starttls, ldaps
tls_mode starttls

# Verify TLS certificates (recommended: true for production)
tls_verify_cert true

# TLS CA certificate file path
tls_ca_cert_file /etc/ssl/certs/ca-certificates.crt

# ============================================================================
# TOTP Settings
# ============================================================================

# Enable TOTP validation
# true  - Require password + TOTP code (password123456)
# false - Require password only (TOTP validation skipped)
totp_enabled true

# TOTP mode: append, challenge, web
# append - Concatenate TOTP to password (password123456)
# challenge - Server prompts for TOTP after password validation
# web - Use web authentication (requires web_auth_script)
totp_mode append

# LDAP attribute containing the TOTP secret
totp_attribute totpSecret

# LDAP attribute containing scratch/backup codes
scratch_attribute totpScratchCode

# LDAP attribute containing TOTP enrolment status
# Values: none, pending, active, disabled, bypassed
status_attribute totpStatus

# LDAP attribute containing enrolment date
# Format: LDAP GeneralizedTime (YYYYMMDDhhmmssZ)
enrolled_date_attribute totpEnrolledDate

# Prefix for TOTP secret in LDAP attribute
# Use empty string if secrets are stored directly without prefix
totp_prefix

# Prefix for backup/scratch codes
# When using dedicated totpScratchCode attribute, leave empty (no prefix needed)
# Only use a prefix if storing codes in a generic multi-purpose attribute
scratch_prefix

# TOTP time step in seconds (RFC 6238 standard: 30)
time_step 30

# Time window tolerance (number of steps to check before/after current time)
# window_size 3 means ±90 seconds tolerance (3 × 30 second time_step)
window_size 3

# ============================================================================
# MFA Enforcement Settings
# ============================================================================

# Grace period for new users to set up MFA (days)
# Users with totpStatus=pending have this many days before enforcement
grace_period_days 7

# Enforcement mode: strict, graceful, warn_only
# strict   - Block all access after grace period
# graceful - Block services but allow web UI for MFA setup
# warn_only - Show warnings but don't block (testing only)
enforcement_mode graceful

# Service DN allowed during MFA setup (bypasses enforcement)
# Allows users to log into the web UI to set up MFA even if grace expired
setup_service_dn cn=ldap-user-manager,ou=services,dc=example,dc=com

# ============================================================================
# Debug and Legacy Settings
# ============================================================================

# Enable debug logging to syslog and stderr
# WARNING: May log sensitive information; disable in production
debug false

# Challenge prompt for challenge-response mode
challenge_prompt Enter TOTP code:

# Web authentication script path (for web mode only)
web_auth_script

# Fallback to file-based OTP (legacy compatibility)
# Not recommended for new deployments; use LDAP-backed TOTP only
fallback_to_file false
